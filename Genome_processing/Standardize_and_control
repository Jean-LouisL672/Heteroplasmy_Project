#!/bin/env python3
import os
import zipfile
import re

# Directories
OUTPUTDIR = "/data/projet2/02_Phylogeny_part/fasta_files"
GENOMEDIR = "/data/projet2/02_Phylogeny_part"
REPORT_FILE = "/data/projet2/02_Phylogeny_part/fasta_files/report.txt"

# Create output directory if it doesn't exist
os.makedirs(OUTPUTDIR, exist_ok=True)


# Function to standardize filename
def standardize_filename(header):
    # Example header: >NC_000000 Species_name ...
    match = re.match(r'^>(\S+)\s+(\S+)', header)
    if match:
        accession = match.group(1)
        species = match.group(2).replace(" ", "_")
        return f"{species}_{accession}.fasta"
    else:
        # fallback: use accession only
        accession = header.split()[0][1:]
        return f"{accession}.fasta"

# Control and rename fasta files
report_lines = []
for fname in os.listdir(OUTPUTDIR):
    if fname.endswith(".fasta") or fname.endswith(".fa"):
        fpath = os.path.join(OUTPUTDIR, fname)
        with open(fpath, "r") as f:
            lines = f.readlines()
        if not lines or not lines[0].startswith(">"):
            report_lines.append(f"{fname}: Format FASTA incorrect (pas de header)\n")
            continue
        header = lines[0].strip()
        seq = "".join([l.strip() for l in lines[1:]])
        # Vérification des caractères
        if set(seq.upper()) - set("ATGCN"):
            report_lines.append(f"{fname}: Caractères inattendus dans la séquence\n")
        else:
            report_lines.append(f"{fname}: OK\n")
        # Renommage
        new_fname = standardize_filename(header)
        new_fpath = os.path.join(OUTPUTDIR, new_fname)
        os.rename(fpath, new_fpath)

# Écriture du rapport
with open(REPORT_FILE, "w") as rep:
    rep.writelines(report_lines)

print("Contrôle et renommage terminés. Rapport généré dans report.txt")